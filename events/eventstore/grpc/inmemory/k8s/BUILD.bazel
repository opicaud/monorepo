load("@io_bazel_rules_docker//container:container.bzl", "container_image", "container_push")
load("@io_bazel_rules_docker//go:image.bzl", "go_image")
load("@rules_helm//helm:defs.bzl", "helm_chart", "helm_lint_test")
load("@container_structure_test//:defs.bzl", "container_structure_test")
load("@rules_pkg//:pkg.bzl", "pkg_tar")

pkg_tar(
    name = "tar",
    srcs = ["//events/eventstore/grpc/inmemory/cmd:cmd_linux"],
)

load("@rules_oci//oci:defs.bzl", "oci_image", "oci_push", "oci_tarball")
load("@rules_oci//examples/push:stamp_tags.bzl", "stamp_tags")

oci_image(
    name = "oci_cmd_image",
    base = "@distroless_go",
    cmd = ["./cmd_linux"],
    tars = [":tar"],
)

container_structure_test(
    name = "oci_cmd_test",
    configs = ["oci_cmd_test.yaml"],
    image = ":oci_cmd_image",
)

oci_tarball(
    name = "tarball",
    image = ":oci_cmd_image",
    repo_tags = ["eventstore:latest"],
)

stamp_tags(
    name = "stamped",
    remote_tags = [
        """($stamp.STABLE_EVENTS // "0.0.0")""",
    ],
)

oci_push(
    name = "oci_cmd_image.push",
    image = ":oci_cmd_image",
    remote_tags = ":stamped",
    repository = "localhost:5000/eventstore",
)

#Deprecated
helm_chart(
    name = "helm",
    images = [
        ":pact_verifier_eventstore.push",
    ],
    visibility = ["//visibility:public"],
)

#Deprecated
container_image(
    name = "pact_verifier_eventstore",
    base = "//pact-helper/api:pact_verifier_cli_with_grpc_plugin_image",
    cmd = ["pact_verifier_cli --help"],
    directory = "/consumer_contracts",
    files = ["//shape-app:contract_shape_app_consumer"],
)

oci_image(
    name = "oci_pact_verifier_eventstore",
    base = "//pact-helper/api:oci_pact_verifier_cli_with_grpc_plugin_image",
    tars = [":contracts"],
)

pkg_tar(
    name = "contracts",
    srcs = ["//shape-app:contract_shape_app_consumer"],
)

stamp_tags(
    name = "stamped_pact_helper",
    remote_tags = [
        """($stamp.STABLE_PACT_HELPER // "0.0.0")""",
    ],
)

oci_push(
    name = "oci_pact_verifier_eventstore.push",
    image = ":oci_pact_verifier_eventstore",
    remote_tags = ":stamped_pact_helper",
    repository = "localhost:5000/pact_verifier_eventstore",
)


#Deprecated
container_push(
    name = "pact_verifier_eventstore.push",
    format = "Docker",
    image = ":pact_verifier_eventstore",
    registry = "$(registry)",
    repository = "pact_verifier_eventstore",
    tag = "{STABLE_EVENTS}",
    visibility = ["//visibility:private"],
)

helm_lint_test(
    name = "helm_test",
    chart = ":helm",
)
